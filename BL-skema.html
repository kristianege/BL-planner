<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Planlægning 2026</title>
<style>
    /* --- GOOGLE SHEETS DARK MODE PALETTE --- */
    :root {
        --bg-body: #202124;       /* Main Dark Background */
        --bg-header: #35363a;     /* Column/Row Headers */
        --border: #5f6368;        /* Grid Lines */
        --text-main: #e8eaed;     /* Primary Text */
        --text-muted: #9aa0a6;    /* Secondary Text */
        --google-green: #1e8e3e;  /* Save Button */
        --google-blue: #8ab4f8;   /* Selection / Active */
        --selection-bg: rgba(138, 180, 248, 0.15);
        --btn-bg: #3c4043;
        --btn-hover: #5f6368;
    }

    body { 
        font-family: 'Roboto', 'Segoe UI', Arial, sans-serif; 
        font-size: 13px; margin: 0; padding: 0; height: 100vh; 
        display: flex; flex-direction: column; 
        background-color: var(--bg-body); 
        color: var(--text-main); 
    }
    
    /* Custom Dark Scrollbar */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: #5f6368; border-radius: 5px; border: 2px solid var(--bg-body); }
    ::-webkit-scrollbar-thumb:hover { background: #9aa0a6; }

    /* --- TABS (Material Design Style) --- */
    .nav-tabs { 
        background: var(--bg-body); display: flex; padding: 0 16px; align-items: center; 
        border-bottom: 1px solid var(--border); 
    }
    .nav-tab { 
        padding: 12px 24px; color: var(--text-muted); cursor: pointer; border: none; background: none; 
        font-size: 14px; font-weight: 500; border-bottom: 3px solid transparent; 
        transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .nav-tab:hover { color: var(--text-main); background-color: rgba(255,255,255,0.05); }
    .nav-tab.active { color: var(--google-blue); border-bottom-color: var(--google-blue); }
    .nav-tab.disabled-element { color: #444; cursor: not-allowed; pointer-events: none; }

    /* Views */
    .view-section { display: none; flex-grow: 1; flex-direction: column; overflow: hidden; }
    .view-section.active { display: flex; }

    /* Toolbar */
    .toolbar { 
        padding: 8px 16px; background: #292a2d; border-bottom: 1px solid var(--border); 
        display: flex; align-items: center; gap: 12px; flex-shrink: 0; flex-wrap: wrap; 
    }
    
    /* Buttons - Google Style Pill Shape */
    button { 
        cursor: pointer; padding: 6px 16px; font-size: 13px; font-weight: 500;
        border: 1px solid transparent; 
        background: var(--btn-bg); color: var(--text-main); 
        border-radius: 18px; /* Pill shape */
        transition: background 0.2s, box-shadow 0.2s;
    }
    button:hover { background: var(--btn-hover); box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    
    /* Primary Action (Gem) - Google Green */
    button.primary { background: var(--google-green); color: white; border: none; }
    button.primary:hover { background: #188038; box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
    
    button.danger { background: #d93025; color: white; }
    button.danger:hover { background: #b31412; }
    
    /* State Buttons */
    button.locked-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    button.unlocked-btn { background: #1e8e3e; color: #fff; border: 1px solid transparent; }
    
    button:disabled, button.disabled-element { 
        color: #555; background: #2a2b2e; border: 1px solid #333; cursor: not-allowed; pointer-events: none; 
    }
    
    /* Inputs */
    input { 
        background: #35363a; border: 1px solid var(--border); color: #fff; padding: 6px 8px; border-radius: 4px; outline: none;
    }
    input:focus { border-color: var(--google-blue); }

    .week-selector { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); }
    .week-selector input { width: 40px; text-align: center; font-weight: bold; background: transparent; border: none; border-bottom: 2px solid var(--border); border-radius: 0; }
    .week-selector input:focus { border-bottom-color: var(--google-blue); }

    .file-info { margin-left: 10px; color: var(--text-muted); font-style: italic; font-size: 12px; }
    .dirty-indicator { color: #fbbc04; font-weight: bold; display: none; margin-left: 5px; }
    
    .legend-container { 
        font-size: 11px; color: var(--text-muted); margin-left: auto; display: flex; flex-direction: column; 
        align-items: flex-end; gap: 4px; max-width: 500px; 
    }
    .legend-row { display: flex; gap: 10px; align-items: center; }
    .color-box { display: inline-block; width: 10px; height: 10px; border: 1px solid #555; vertical-align: middle; margin-right: 4px; border-radius: 2px; }

    .copy-actions { display: flex; gap: 8px; border-left: 1px solid #555; padding-left: 12px; margin-left: 10px; }
    .autosave-wrapper { display: flex; align-items: center; gap: 6px; font-size: 12px; border-left: 1px solid #555; padding-left: 12px; margin-left: 10px; color: var(--text-muted); }

    /* Update Banner */
    #updateBanner {
        background-color: #fbbc04; color: #202124; border-bottom: 1px solid #e37400;
        padding: 8px; text-align: center; font-weight: bold; display: none;
        animation: slideDown 0.5s ease-out; font-size: 12px;
    }
    @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    #updateBanner button { margin-left: 15px; background: #202124; color: #fff; border: none; padding: 4px 12px; font-size: 11px; }

    /* Overlays */
    .overlay-screen { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); z-index: 100; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
    }
    .overlay-box { 
        background: #303134; color: #fff; padding: 40px; border: 1px solid #5f6368; 
        box-shadow: 0 12px 24px rgba(0,0,0,0.5); text-align: center; border-radius: 8px; width: 320px; 
    }
    .start-btn { display: block; width: 100%; margin: 15px 0; padding: 12px; font-size: 14px; }
    
    #warningModal { background: rgba(0,0,0,0.85); z-index: 200; display: none; }
    .warning-box { 
        background: #303134; color: #fff; padding: 30px; border-radius: 8px; 
        text-align: center; width: 350px; border-top: 4px solid #fbbc04; 
    }
    .warning-timer { font-size: 36px; font-weight: 300; margin: 20px 0; color: #fbbc04; font-family: monospace; }

    /* Tabel Container */
    .sheet-container { flex-grow: 1; overflow: auto; position: relative; background: var(--bg-body); }
    table { border-collapse: collapse; width: max-content; }
    
    th, td { 
        border: 1px solid var(--border); padding: 0 4px; text-align: center; 
        height: 28px; min-width: 35px; color: var(--text-main); 
        box-sizing: border-box;
    }
    
    th { 
        background: var(--bg-header); color: #e8eaed; border-color: var(--border);
        position: sticky; top: 0; z-index: 10; font-weight: 600; font-size: 12px;
    }
    
    /* Sticky Columns - Matching background to prevent see-through */
    .col-select { position: sticky; left: 0; width: 30px; z-index: 12; background-color: var(--bg-header); border-right: 1px solid var(--border); }
    .col-togt { position: sticky; left: 30px; width: 80px; z-index: 12; background-color: var(--bg-body); border-right: 1px solid var(--border); font-weight: bold; }
    .col-station { position: sticky; left: 110px; width: 140px; z-index: 11; background-color: var(--bg-body); border-right: 1px solid var(--border); text-align: left; padding-left: 8px;}
    .col-nr { position: sticky; left: 250px; width: 50px; z-index: 11; background-color: var(--bg-body); border-right: 1px solid var(--border); }
    .col-link-1 { position: sticky; left: 300px; width: 50px; z-index: 11; background-color: var(--bg-body); border-right: 1px solid var(--border); font-size: 11px; }
    .col-link-2 { position: sticky; left: 350px; width: 50px; z-index: 11; background-color: var(--bg-body); border-right: 1px solid var(--border); font-size: 11px; }
    
    /* Summary Column Highlight */
    .col-summary { 
        position: sticky; left: 400px; width: 60px; z-index: 11; 
        background-color: #3c4043; border-right: 2px solid #777; 
        font-weight: bold; color: #fff; 
    }
    
    /* Sum Columns */
    .col-sum { background-color: #2d2e31; color: #9aa0a6; font-weight: bold; min-width: 30px; border: 1px solid var(--border); font-size: 11px; }

    /* Active Cell Focus - Google Blue Border */
    td:focus { outline: 2px solid var(--google-blue); z-index: 20; border-radius: 1px; }
    
    .togt-cell { color: #fff; text-shadow: 0px 0px 2px rgba(0,0,0,0.8); }
    a.cell-link { text-decoration: none; color: var(--google-blue); font-weight: bold; }
    a.cell-link:hover { text-decoration: underline; }

    .has-note { position: relative; }
    .has-note::after { 
        content: ''; position: absolute; top: 0px; right: 0px; 
        border-style: solid; border-width: 0 6px 6px 0; 
        border-color: transparent #d93025 transparent transparent; 
        pointer-events: none; 
    }

    /* Selection Logic */
    tr.selected td { background-color: var(--selection-bg) !important; }
    /* Override sticky columns background when selected */
    tr.selected .col-togt, tr.selected .col-station, tr.selected .col-nr, tr.selected .col-link-1, tr.selected .col-link-2 {
        background-color: #2d333b !important; 
        border-top: 1px solid var(--google-blue);
        border-bottom: 1px solid var(--google-blue);
    }
    
    .row-checkbox { cursor: pointer; width: 14px; height: 14px; margin-top: 6px; accent-color: var(--google-blue); }
    .locked-cell { cursor: default; color: #e8eaed; }

    /* Settings Tab */
    .settings-container { padding: 20px; max-width: 900px; margin: 0 auto; overflow: auto; display: flex; gap: 40px; color: #eee; }
    .settings-col { flex: 1; }
    .settings-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .settings-table th, .settings-table td { padding: 8px; border: 1px solid #5f6368; text-align: left; color: #eee; }
    .settings-table th { background: #35363a; }
    .settings-table td input { background: #202124; color: #fff; border: 1px solid #5f6368; width: 100%; box-sizing: border-box; }
    .settings-table td input:focus { border-color: var(--google-blue); }
    input[type="color"] { width: 40px; height: 30px; border: none; cursor: pointer; padding: 0; background: none; }
</style>
</head>
<body>

<div id="updateBanner">
    OBS: En kollega har netop gemt en ny version af filen! 
    <button onclick="window.location.reload()">Genindlæs</button>
</div>

<div id="startScreen" class="overlay-screen">
    <div class="overlay-box">
        <h2>Planlægning</h2>
        <button id="btnReloadLast" class="primary start-btn" style="display:none;">Genåbn seneste fil</button>
        <button id="btnStartOpen" class="start-btn">Åbn eksisterende fil</button>
        <button id="btnStartNew" class="start-btn">Opret ny fil</button>
    </div>
</div>

<div id="warningModal" class="overlay-screen">
    <div class="warning-box">
        <h2>Er du der stadig?</h2>
        <p>Siden har været inaktiv i 9 minutter.</p>
        <p>For din sikkerhed lukker siden og gemmer om:</p>
        <div id="countdownDisplay" class="warning-timer">60</div>
        <button class="primary start-btn" onclick="continueSession()">Jeg er her stadig (Fortsæt)</button>
    </div>
</div>

<div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('plan')">Planlægning</button>
    <button id="tabSettings" class="nav-tab" onclick="switchTab('settings')">Indstillinger</button>
</div>

<div id="view-plan" class="view-section active">
    <div class="toolbar">
        <button id="btnSave" title="Gem (Ctrl+S)" class="primary">Gem</button>
        <button onclick="attemptClose()">Luk</button>
        <button id="btnLock" class="locked-btn" onclick="toggleLock()" title="Klik for at redigere">Låst (Visning)</button>
        
        <div class="week-selector">
            <span>Uge</span>
            <input type="number" id="weekInput" min="1" max="53" value="1" onchange="updateSummaryColumn()">
        </div>
        
        <div class="autosave-wrapper">
            <input type="checkbox" id="chkAutoSave" checked title="Gem automatisk hvert minut">
            <label for="chkAutoSave" title="Gem automatisk hvert minut">Auto-gem</label>
        </div>

        <div class="copy-actions">
            <button onclick="copyData('text')" title="Kopier navn, nr og koder som tekststreng">Kopier Tekst</button>
            <button onclick="copyData('excel')" title="God til Excel">Kopier Excel</button>
        </div>

        <span id="currentFileName" class="file-info">Ingen fil</span>
        <span id="dirtyIndicator" class="dirty-indicator" title="Ugemte ændringer">*</span>

        <button id="btnAddRow" onclick="addRow()" style="margin-left: 20px;">+ Række</button>
        
        <div class="legend-container">
            <div class="legend-row" id="legendCodes"></div>
            <div class="legend-row" id="legendColors"></div>
            <div class="legend-row" style="margin-top:2px; font-style:italic;">Tryk 'n' for note</div>
        </div>
    </div>

    <div class="sheet-container">
        <table id="grid">
            <thead>
                <tr id="headerRow">
                    <th class="col-select"><input type="checkbox" onclick="toggleAll(this)"></th>
                    <th class="col-togt">Togt</th>
                    <th class="col-station">Station</th>
                    <th class="col-nr">Nr.</th>
                    <th class="col-link-1">VanDa</th>
                    <th class="col-link-2">WMS</th>
                    <th class="col-summary" id="summaryHeader">Uge ?</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<div id="view-settings" class="view-section">
    <div class="settings-container">
        <div class="settings-col">
            <h3>Koder</h3>
            <table class="settings-table">
                <thead><tr><th>Tast</th><th>Vis</th><th>Betydning</th><th></th></tr></thead>
                <tbody id="settingsBodyCodes"></tbody>
            </table>
            <button class="primary" onclick="addNewCode()">+ Ny kode</button>
        </div>
        <div class="settings-col">
            <h3>Farver & Genveje</h3>
            <table class="settings-table">
                <thead><tr><th>Farve</th><th>Status</th><th>Genvej (tast / dblclick)</th><th></th></tr></thead>
                <tbody id="settingsBodyColors"></tbody>
            </table>
            <button class="primary" onclick="addNewColor()">+ Ny status</button>
        </div>
    </div>
</div>

<script>
    const UGER = 53;
    const TOGT_PALETTE = ['#882e36','#8c5c2e','#8c862e','#4a8c38','#2e5c8c','#6a2e8c','#8c2e75','#5a6838','#386862','#4c526d','#8c4a4e','#8c625e','#8c7a6b','#5a6838','#386862','#4c526d','#7d7536','#6d5a6d','#8c322d','#387d38']; 
    const DEFAULT_CODES = [{ key: 'q', disp: 'Q', desc: 'Vandføring' }, { key: 'h', disp: 'H', desc: 'Skalapæl' }, { key: 'k', disp: 'K', desc: 'Kemi' }, { key: 's', disp: 's', desc: 'Salinitet' }, { key: 'f', disp: 'f', desc: 'Jern' }, { key: 'a', disp: 'a', desc: 'Alkalinitet' }];
    const DEFAULT_STATUS = [
        { color: '#202124', desc: 'Ingen status', shortcut: '' },
        { color: '#3c7042', desc: 'Prøvetaget', shortcut: '1' }, 
        { color: '#8a3c3c', desc: 'Tørlagt', shortcut: 'dblclick' }, 
        { color: '#3c5a8a', desc: 'Modtaget', shortcut: '' }
    ];

    let appData = { settings: JSON.parse(JSON.stringify(DEFAULT_CODES)), statusSettings: JSON.parse(JSON.stringify(DEFAULT_STATUS)), rows: [] };
    let fileHandle = null, displayWeek = 1, selectedIndices = new Set(), isLocked = true;
    let hasUnsavedChanges = false;
    let lastFileModTime = 0;

    const AUTO_SAVE_INTERVAL_MS = 60000;
    const INACTIVITY_WARNING_MS = 9 * 60 * 1000; 
    const INACTIVITY_FINAL_MS = 60 * 1000; 
    const POLL_INTERVAL_MS = 10000;

    let inactivityTimer = null, countdownTimer = null, countdownInterval = null;

    function getCurrentWeek() { const d = new Date(); const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1)); return Math.ceil((((date - yearStart) / 86400000) + 1) / 7); }
    displayWeek = getCurrentWeek();
    document.getElementById('weekInput').value = displayWeek;
    document.getElementById('summaryHeader').innerText = "Uge " + displayWeek;

    const headerRow = document.getElementById('headerRow');
    for (let i = 1; i <= UGER; i++) { let th = document.createElement('th'); th.innerText = i; if(i === displayWeek) { th.style.backgroundColor = "#444"; th.style.borderBottom = "2px solid #8ab4f8"; } headerRow.appendChild(th); }
    updateLegend();

    setInterval(() => { const chk = document.getElementById('chkAutoSave'); if (chk && chk.checked && hasUnsavedChanges && fileHandle) performAutoSave(); }, AUTO_SAVE_INTERVAL_MS);
    setInterval(checkForExternalUpdates, POLL_INTERVAL_MS);

    async function checkForExternalUpdates() {
        if (!fileHandle) return;
        try {
            const fileOnDisk = await fileHandle.getFile();
            if (fileOnDisk.lastModified > lastFileModTime + 2000) { document.getElementById('updateBanner').style.display = 'block'; }
        } catch (e) { console.log("Fejl i poll:", e); }
    }

    function resetInactivityTimer() { if(document.getElementById('warningModal').style.display === 'flex') return; clearTimeout(inactivityTimer); inactivityTimer = setTimeout(showInactivityWarning, INACTIVITY_WARNING_MS); }
    function setupActivityListeners() { window.addEventListener('mousemove', resetInactivityTimer); window.addEventListener('keydown', resetInactivityTimer); window.addEventListener('click', resetInactivityTimer); resetInactivityTimer(); }
    function showInactivityWarning() {
        const modal = document.getElementById('warningModal'); modal.style.display = 'flex';
        let secondsLeft = 60; document.getElementById('countdownDisplay').innerText = secondsLeft;
        countdownInterval = setInterval(() => { secondsLeft--; document.getElementById('countdownDisplay').innerText = secondsLeft; if(secondsLeft <= 0) clearInterval(countdownInterval); }, 1000);
        countdownTimer = setTimeout(performAutoClose, INACTIVITY_FINAL_MS);
    }
    function continueSession() { clearTimeout(countdownTimer); clearInterval(countdownInterval); document.getElementById('warningModal').style.display = 'none'; resetInactivityTimer(); }
    async function performAutoClose() { clearInterval(countdownInterval); document.getElementById('warningModal').innerHTML = '<div class="warning-box"><h2>Auto-gemmer...</h2></div>'; await performSave(true); document.body.innerHTML = `<div style="display:flex; height:100vh; align-items:center; justify-content:center; flex-direction:column; background:#202124; color:#e8eaed;"><div style="background:#303134; padding:40px; border-radius:8px; border:1px solid #5f6368; text-align:center;"><h1 style="color:#fff;">Session Afsluttet</h1><p>Du var inaktiv i 10 minutter.</p><p style="color:#1e8e3e; font-weight:bold;">Dine data er blevet gemt.</p><button onclick="window.location.reload()" style="padding:10px 20px; cursor:pointer; font-size:16px; background:#8ab4f8; border:none; color:#202124; border-radius:18px;">Log ind igen</button></div></div>`; window.close(); }

    const dbName = 'PlanDB_MultiUser';
    function getDB() { return new Promise((res, rej) => { const r = indexedDB.open(dbName, 1); r.onupgradeneeded = e => e.target.result.createObjectStore('settings'); r.onsuccess = e => res(e.target.result); r.onerror = e => rej(e); }); }
    async function saveHandle(handle) { const db = await getDB(); const tx = db.transaction('settings', 'readwrite'); tx.objectStore('settings').put(handle, 'lastFileHandle'); }
    async function getLastHandle() { const db = await getDB(); return new Promise(res => { const tx = db.transaction('settings', 'readonly'); const r = tx.objectStore('settings').get('lastFileHandle'); r.onsuccess = () => res(r.result); }); }

    window.addEventListener('DOMContentLoaded', async () => {
        setupActivityListeners(); 
        const lastHandle = await getLastHandle();
        if (lastHandle) {
            const btn = document.getElementById('btnReloadLast'); btn.style.display = 'block'; btn.innerText = `Genåbn "${lastHandle.name}"`;
            btn.onclick = async () => { fileHandle = lastHandle; if (await verifyPermission(fileHandle, true)) { await loadFromFile(); document.getElementById('startScreen').style.display = 'none'; } };
        }
        updateLockButton();
    });

    document.getElementById('btnStartOpen').onclick = async () => { try { [fileHandle] = await window.showOpenFilePicker({ types: [{ description: 'JSON Plan', accept: { 'application/json': ['.json'] } }] }); await saveHandle(fileHandle); await loadFromFile(); document.getElementById('startScreen').style.display = 'none'; } catch (e) {} };
    document.getElementById('btnStartNew').onclick = async () => { appData.settings = JSON.parse(JSON.stringify(DEFAULT_CODES)); appData.statusSettings = JSON.parse(JSON.stringify(DEFAULT_STATUS)); appData.rows = []; addRow(); updateLegend(); document.getElementById('startScreen').style.display = 'none'; document.getElementById('currentFileName').innerText = "Ny (Ikke gemt)"; markDirty(false); };

    async function verifyPermission(handle, withWrite) { const opts = withWrite ? { mode: 'readwrite' } : {}; if ((await handle.queryPermission(opts)) === 'granted') return true; if ((await handle.requestPermission(opts)) === 'granted') return true; return false; }
    
    async function loadFromFile() {
        const file = await fileHandle.getFile(); lastFileModTime = file.lastModified; 
        const text = await file.text();
        document.getElementById('currentFileName').innerText = file.name;
        document.getElementById('updateBanner').style.display = 'none';
        try { 
            const json = JSON.parse(text);
            if (Array.isArray(json)) { appData.rows = json; appData.settings = JSON.parse(JSON.stringify(DEFAULT_CODES)); appData.statusSettings = JSON.parse(JSON.stringify(DEFAULT_STATUS)); } 
            else { 
                appData = json; 
                if(!appData.settings) appData.settings = JSON.parse(JSON.stringify(DEFAULT_CODES)); 
                if(!appData.statusSettings) appData.statusSettings = JSON.parse(JSON.stringify(DEFAULT_STATUS));
                if(!appData.rows) appData.rows = [];
                appData.statusSettings.forEach((s, idx) => { if(!s.shortcut) s.shortcut = (idx === 2 ? 'dblclick' : ''); });
            }
        } catch (e) { appData.rows = []; }
        if (appData.rows.length === 0) addRow();
        markDirty(false); updateLegend(); render();
    }

    function markDirty(isDirty) { hasUnsavedChanges = isDirty; const ind = document.getElementById('dirtyIndicator'); const btn = document.getElementById('btnSave'); if (isDirty) { ind.style.display = 'inline'; document.title = "* Planlægning 2026"; btn.style.background = "#fbbc04"; btn.style.color = "#000"; } else { ind.style.display = 'none'; document.title = "Planlægning 2026"; btn.style.background = "#1e8e3e"; btn.style.color = "#fff"; } }

    async function performSave(silent = false) {
        if (!fileHandle) { try { fileHandle = await window.showSaveFilePicker({ suggestedName: 'plan.json' }); await saveHandle(fileHandle); } catch (e) { return false; } }
        try {
            const fileOnDisk = await fileHandle.getFile();
            if (fileOnDisk.lastModified > lastFileModTime + 2000) { if(!silent) alert("KONFLIKT!\n\nEn anden har ændret filen siden du åbnede den.\nGemning afbrudt."); return false; }
            const writable = await fileHandle.createWritable(); await writable.write(JSON.stringify(appData)); await writable.close();
            const newFile = await fileHandle.getFile(); lastFileModTime = newFile.lastModified;
            document.getElementById('currentFileName').innerText = fileHandle.name; markDirty(false);
            const btn = document.getElementById('btnSave'); if(!silent) { btn.innerText = "Gemt!"; setTimeout(() => { btn.innerText = "Gem"; }, 1000); }
            return true;
        } catch (e) { if(!silent) alert("Fejl: " + e); return false; }
    }
    async function performAutoSave() { const btn = document.getElementById('btnSave'); const originalText = btn.innerText; btn.innerText = "Gemmer..."; const success = await performSave(true); if(success) setTimeout(() => { btn.innerText = originalText; }, 1000); }
    document.getElementById('btnSave').onclick = async () => { await performSave(false); };
    document.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); performSave(false); } });
    async function attemptClose() { if (hasUnsavedChanges) { if (confirm("Du har ugemte ændringer!\n\nTryk OK for at GEMME og lukke.\nTryk Annuller for at lukke UDEN at gemme.")) { const saved = await performSave(false); if (saved) window.location.reload(); } else { window.location.reload(); } } else { window.location.reload(); } }
    window.addEventListener('beforeunload', (e) => { if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; } });

    function switchTab(tabName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabName).classList.add('active');
        const buttons = document.querySelectorAll('.nav-tab');
        if(tabName === 'plan') { buttons[0].classList.add('active'); updateLegend(); render(); }
        if(tabName === 'settings') { if(isLocked) return switchTab('plan'); buttons[1].classList.add('active'); renderSettingsTables(); }
    }
    function renderSettingsTables() {
        const tbodyCodes = document.getElementById('settingsBodyCodes'); tbodyCodes.innerHTML = '';
        appData.settings.forEach((code, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="text" maxlength="1" value="${code.key}" onchange="updateSet(0, ${idx}, 'key', this.value)"></td><td><input type="text" maxlength="1" value="${code.disp}" onchange="updateSet(0, ${idx}, 'disp', this.value)"></td><td><input type="text" value="${code.desc}" onchange="updateSet(0, ${idx}, 'desc', this.value)"></td><td><button class="danger" onclick="removeSet(0, ${idx})">Slet</button></td>`;
            tbodyCodes.appendChild(tr);
        });
        const tbodyColors = document.getElementById('settingsBodyColors'); tbodyColors.innerHTML = '';
        appData.statusSettings.forEach((stat, idx) => {
            const tr = document.createElement('tr');
            const delBtn = idx === 0 ? '' : `<button class="danger" onclick="removeSet(1, ${idx})">Slet</button>`;
            const shortcutVal = stat.shortcut || '';
            tr.innerHTML = `<td><input type="color" value="${stat.color}" onchange="updateSet(1, ${idx}, 'color', this.value)"></td><td><input type="text" value="${stat.desc}" onchange="updateSet(1, ${idx}, 'desc', this.value)"></td><td><input type="text" value="${shortcutVal}" placeholder="fx '1'" onchange="updateSet(1, ${idx}, 'shortcut', this.value)"></td><td>${delBtn}</td>`;
            tbodyColors.appendChild(tr);
        });
    }
    function updateSet(type, idx, field, val) { if(type === 0) { if(field === 'key') val = val.toLowerCase(); appData.settings[idx][field] = val; } else { appData.statusSettings[idx][field] = val; } markDirty(true); }
    function addNewCode() { appData.settings.push({ key: '', disp: '', desc: '' }); renderSettingsTables(); markDirty(true); }
    function addNewColor() { appData.statusSettings.push({ color: '#cccccc', desc: 'Ny status', shortcut: '' }); renderSettingsTables(); markDirty(true); }
    function removeSet(type, idx) { if(!confirm("Er du sikker?")) return; if(type === 0) appData.settings.splice(idx, 1); else appData.statusSettings.splice(idx, 1); renderSettingsTables(); markDirty(true); }
    function updateLegend() {
        const codeParts = appData.settings.map(c => `${c.disp}=${c.desc}`); document.getElementById('legendCodes').innerText = "Koder: " + codeParts.join(', ');
        const colorContainer = document.getElementById('legendColors'); colorContainer.innerHTML = 'Farver: ';
        appData.statusSettings.forEach((s, i) => { if (i === 0 && s.desc.toLowerCase().includes('ingen')) return; const span = document.createElement('span'); span.style.marginRight = "8px"; span.innerHTML = `<span class="color-box" style="background:${s.color}"></span>${s.desc}`; colorContainer.appendChild(span); });
    }

    function toggleLock() { isLocked = !isLocked; updateLockButton(); render(); }
    function updateLockButton() {
        const btn = document.getElementById('btnLock'), btnAdd = document.getElementById('btnAddRow'), tabSet = document.getElementById('tabSettings');
        if (isLocked) { btn.innerText = "Låst (Visning)"; btn.className = "locked-btn"; btnAdd.disabled = true; btnAdd.classList.add('disabled-element'); tabSet.classList.add('disabled-element'); } 
        else { btn.innerText = "Rediger (Aktiv)"; btn.className = "unlocked-btn"; btnAdd.disabled = false; btnAdd.classList.remove('disabled-element'); tabSet.classList.remove('disabled-element'); }
    }
    function updateSummaryColumn() { const input = document.getElementById('weekInput'); let val = parseInt(input.value); if(val < 1) val = 1; if(val > UGER) val = UGER; displayWeek = val; document.getElementById('summaryHeader').innerText = "Uge " + displayWeek; render(); }
    function getTogtColor(text) { if (!text) return '#fff'; let hash = 0; for (let i = 0; i < text.length; i++) { hash = text.charCodeAt(i) + ((hash << 5) - hash); } return TOGT_PALETTE[Math.abs(hash) % TOGT_PALETTE.length]; }
    function toggleRow(idx) { if (selectedIndices.has(idx)) selectedIndices.delete(idx); else selectedIndices.add(idx); render(); }
    function toggleAll(checkbox) { if (checkbox.checked) appData.rows.forEach((_, idx) => selectedIndices.add(idx)); else selectedIndices.clear(); render(); }

    async function copyData(mode) {
        if (selectedIndices.size === 0) return alert("Vælg mindst én række først.");
        const sortedIndices = Array.from(selectedIndices).sort((a, b) => a - b);
        if (mode === 'excel') {
            let htmlContent = `<table border="1" style="border-collapse: collapse;"><thead><tr><th>Togt</th><th>Station</th><th>Nr</th><th>VanDa</th><th>WMS</th><th>Uge ${displayWeek}</th></tr></thead><tbody>`;
            sortedIndices.forEach(idx => {
                const row = appData.rows[idx];
                const station = row.station || ""; const nr = row.nr || ""; const togt = row.togt || "";
                const kode = (row.weeks && row.weeks[displayWeek-1]) ? row.weeks[displayWeek-1].val : "";
                const vandaLink = row.vandaLink ? `<a href="${row.vandaLink}">VanDa</a>` : "";
                const wmsLink = row.wmsLink ? `<a href="${row.wmsLink}">WMS</a>` : "";
                htmlContent += `<tr><td>${togt}</td><td>${station}</td><td>${nr}</td><td>${vandaLink}</td><td>${wmsLink}</td><td>${kode}</td></tr>`;
            });
            htmlContent += `</tbody></table>`;
            const blobHtml = new Blob([htmlContent], { type: "text/html" }); const blobText = new Blob([`Kopieret ${sortedIndices.length} rækker`], { type: "text/plain" });
            const data = [new ClipboardItem({ "text/html": blobHtml, "text/plain": blobText })];
            try { await navigator.clipboard.write(data); alert(`Kopieret (Excel)!`); } catch (err) { alert("Fejl: " + err); }
        }
        else if (mode === 'text') {
            const parts = sortedIndices.map(idx => {
                const row = appData.rows[idx];
                const station = row.station || ""; const nr = row.nr || "";
                const kode = (row.weeks && row.weeks[displayWeek-1]) ? row.weeks[displayWeek-1].val : "";
                return `${station} ${nr} ${kode}`.replace(/\s+/g, ' ').trim();
            });
            const resultString = parts.join(", ");
            try { await navigator.clipboard.writeText(resultString); alert("Tekst kopieret!"); } catch (err) { alert("Fejl: " + err); }
        }
    }

    function render() {
        const tbody = document.getElementById('tbody'); tbody.innerHTML = '';
        const headerRow = document.getElementById('headerRow');
        while (headerRow.children.length > 60) { headerRow.removeChild(headerRow.lastChild); }
        if (!isLocked) { appData.settings.forEach(setting => { let th = document.createElement('th'); th.className = 'col-sum'; th.innerText = "Σ " + setting.disp; headerRow.appendChild(th); }); }
        const ths = headerRow.children; for(let i=7; i < 60; i++) { 
            ths[i].style.backgroundColor = (i - 6 === displayWeek) ? "#3c4043" : "#35363a"; 
            if(i - 6 === displayWeek) ths[i].style.borderBottom = "2px solid #8ab4f8";
            else ths[i].style.borderBottom = "1px solid #5f6368";
        }

        appData.rows.forEach((row, rIdx) => {
            const tr = document.createElement('tr');
            if (selectedIndices.has(rIdx)) tr.className = 'selected';
            const tdCheck = document.createElement('td'); tdCheck.className = 'col-select';
            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'row-checkbox'; chk.checked = selectedIndices.has(rIdx);
            chk.onclick = (e) => { e.stopPropagation(); toggleRow(rIdx); };
            tdCheck.appendChild(chk); tr.appendChild(tdCheck);

            const togtTd = createMetaCell(rIdx, 'togt', row.togt, 'col-togt togt-cell');
            togtTd.style.backgroundColor = getTogtColor(row.togt);
            togtTd.oninput = (e) => { appData.rows[rIdx].togt = e.target.innerText; e.target.style.backgroundColor = getTogtColor(e.target.innerText); markDirty(true); };
            tr.appendChild(togtTd);

            tr.appendChild(createMetaCell(rIdx, 'station', row.station, 'col-station'));
            tr.appendChild(createMetaCell(rIdx, 'nr', row.nr, 'col-nr'));

            const tdVanda = document.createElement('td'); tdVanda.className = 'col-link-1';
            if (isLocked) { if(row.vandaLink) tdVanda.innerHTML = `<a href="${row.vandaLink}" target="_blank" class="cell-link" onclick="event.stopPropagation()">VanDa</a>`; } 
            else { const inp = document.createElement('input'); inp.type = "text"; inp.value = row.vandaLink || ""; inp.placeholder = "URL..."; inp.style.width = "90%"; inp.oninput = (e) => { appData.rows[rIdx].vandaLink = e.target.value; markDirty(true); }; inp.onclick = (e) => e.stopPropagation(); tdVanda.appendChild(inp); }
            tr.appendChild(tdVanda);

            const tdWms = document.createElement('td'); tdWms.className = 'col-link-2';
            if (isLocked) { if(row.wmsLink) tdWms.innerHTML = `<a href="${row.wmsLink}" target="_blank" class="cell-link" onclick="event.stopPropagation()">WMS</a>`; } 
            else { const inp = document.createElement('input'); inp.type = "text"; inp.value = row.wmsLink || ""; inp.placeholder = "URL..."; inp.style.width = "90%"; inp.oninput = (e) => { appData.rows[rIdx].wmsLink = e.target.value; markDirty(true); }; inp.onclick = (e) => e.stopPropagation(); tdWms.appendChild(inp); }
            tr.appendChild(tdWms);

            const summaryTd = document.createElement('td'); summaryTd.className = 'col-summary';
            const weekData = (row.weeks && row.weeks[displayWeek-1]) ? row.weeks[displayWeek-1] : {val:'', stat:0};
            summaryTd.innerText = weekData.val;
            
            // DARK MODE STATUS COLOR LOGIC
            if(weekData.stat === 0) {
                summaryTd.style.backgroundColor = ""; // Default CSS dark
                summaryTd.style.color = ""; 
            } else {
                if(appData.statusSettings[weekData.stat]) {
                    summaryTd.style.backgroundColor = appData.statusSettings[weekData.stat].color;
                    summaryTd.style.color = "#000"; // Force black text on colored cells
                }
            }
            tr.appendChild(summaryTd);

            for (let w = 0; w < UGER; w++) {
                const td = document.createElement('td');
                const cellData = row.weeks && row.weeks[w] ? row.weeks[w] : { val: '', stat: 0 };
                td.innerText = cellData.val;
                if(cellData.note) { td.classList.add('has-note'); td.title = cellData.note; } else { td.title = ""; }
                
                // DARK MODE STATUS COLOR LOGIC
                if (cellData.stat === 0) {
                    // Default / Empty
                    td.style.backgroundColor = ""; 
                    td.style.color = "";
                } else {
                    // Active Status
                    if (appData.statusSettings[cellData.stat]) {
                        td.style.backgroundColor = appData.statusSettings[cellData.stat].color;
                        td.style.color = "#000"; // Force black text
                    }
                }

                if((w + 1) === displayWeek) { 
                    td.style.borderLeft = "2px solid #777"; 
                    td.style.borderRight = "2px solid #777"; 
                    if (cellData.stat === 0) {
                        td.style.backgroundColor = "rgba(255,255,255,0.05)"; // Slight highlight for active week empty cell
                    }
                }
                
                td.tabIndex = 0; td.onclick = () => { td.focus(); }; td.ondblclick = () => handleCellDblClick(rIdx, w); td.onkeydown = (e) => handleInput(e, rIdx, w);
                tr.appendChild(td);
            }

            if (!isLocked) {
                appData.settings.forEach(setting => {
                    let count = 0;
                    for(let w=0; w<UGER; w++) { const val = (row.weeks && row.weeks[w]) ? row.weeks[w].val : ""; if(val && val.includes(setting.disp)) count++; }
                    const tdSum = document.createElement('td'); tdSum.className = 'col-sum'; tdSum.innerText = count > 0 ? count : ''; if(count > 0) { tdSum.style.backgroundColor = "#2d2e31"; tdSum.style.color = "#fff"; } 
                    tr.appendChild(tdSum);
                });
            }
            tbody.appendChild(tr);
        });
    }

    function createMetaCell(rIdx, key, val, classes) { const td = document.createElement('td'); td.contentEditable = !isLocked; td.className = classes || ''; if(isLocked) td.className += ' locked-cell'; td.innerText = val || ''; td.oninput = (e) => { appData.rows[rIdx][key] = e.target.innerText; markDirty(true); }; return td; }
    function handleCellDblClick(rIdx, wIdx) { const dblStatIndex = appData.statusSettings.findIndex(s => s.shortcut === 'dblclick'); if (dblStatIndex >= 0) { if (!appData.rows[rIdx].weeks) appData.rows[rIdx].weeks = {}; if (!appData.rows[rIdx].weeks[wIdx]) appData.rows[rIdx].weeks[wIdx] = { val: '', stat: 0 }; appData.rows[rIdx].weeks[wIdx].stat = dblStatIndex; markDirty(true); render(); } }
    function handleInput(e, rIdx, wIdx) {
        if (!appData.rows[rIdx].weeks) appData.rows[rIdx].weeks = {}; if (!appData.rows[rIdx].weeks[wIdx]) appData.rows[rIdx].weeks[wIdx] = { val: '', stat: 0 };
        let cell = appData.rows[rIdx].weeks[wIdx]; let needsRender = false; const key = e.key.toLowerCase(); 
        const shortcutStatIndex = appData.statusSettings.findIndex(s => s.shortcut && s.shortcut.toLowerCase() === key);
        if (shortcutStatIndex >= 0) { e.preventDefault(); cell.stat = shortcutStatIndex; needsRender = true; } 
        else if (key === 'n') { e.preventDefault(); const currentNote = cell.note || ""; const newNote = prompt("Indtast bemærkning:", currentNote); if (newNote !== null) { cell.note = newNote; markDirty(true); render(); return; } }
        else { const setting = appData.settings.find(s => s.key === key); if (setting) { cell.val = (cell.val || '') + setting.disp; needsRender = true; } else if (e.key === 'Backspace') { e.preventDefault(); if(cell.val.length > 0) { cell.val = cell.val.slice(0, -1); needsRender = true; } } else if (e.key === 'Delete') { cell.val = ''; cell.stat = 0; needsRender = true; } else if (e.key === ' ') { e.preventDefault(); const numStatuses = appData.statusSettings.length; cell.stat = (cell.stat + 1) % numStatuses; needsRender = true; } }
        if (needsRender) { markDirty(true); render(); setTimeout(() => { const rows = document.getElementById('tbody').children; if(rows[rIdx]) { const cell = rows[rIdx].children[wIdx + 7]; if(cell) cell.focus(); } }, 0); }
    }
    function addRow() { appData.rows.push({ station: '', nr: '', togt: '', vandaLink: '', wmsLink: '', weeks: {} }); markDirty(true); render(); }
</script>
</body>
</html>
