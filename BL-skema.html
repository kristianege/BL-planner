<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Planl칝gning 2026</title>
<style>
    /* --- GOOGLE SHEETS DARK MODE PALETTE --- */
    :root {
        --bg-body: #202124;       /* Main Dark Background */
        --bg-header: #35363a;     /* Column/Row Headers */
        --border: #5f6368;        /* Grid Lines */
        --text-main: #e8eaed;     /* Primary Text */
        --text-muted: #9aa0a6;    /* Secondary Text */
        --google-green: #1e8e3e;  /* Save Button */
        --google-blue: #8ab4f8;   /* Selection / Active */
        --selection-bg: rgba(138, 180, 248, 0.15);
        --btn-bg: #3c4043;
        --btn-hover: #5f6368;
    }

    body { 
        font-family: 'Roboto', 'Segoe UI', Arial, sans-serif; 
        font-size: 13px; margin: 0; padding: 0; height: 100vh; 
        display: flex; flex-direction: column; 
        background-color: var(--bg-body); 
        color: var(--text-main); 
    }
    
    /* Custom Dark Scrollbar */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: #5f6368; border-radius: 5px; border: 2px solid var(--bg-body); }
    ::-webkit-scrollbar-thumb:hover { background: #9aa0a6; }

    /* --- TABS (Material Design Style) --- */
    .nav-tabs { 
        background: var(--bg-body); display: flex; padding: 0 16px; align-items: center; 
        border-bottom: 1px solid var(--border); 
    }
    .nav-tab { 
        padding: 12px 24px; color: var(--text-muted); cursor: pointer; border: none; background: none; 
        font-size: 14px; font-weight: 500; border-bottom: 3px solid transparent; 
        transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .nav-tab:hover { color: var(--text-main); background-color: rgba(255,255,255,0.05); }
    .nav-tab.active { color: var(--google-blue); border-bottom-color: var(--google-blue); }
    .nav-tab.disabled-element { color: #444; cursor: not-allowed; pointer-events: none; }

    /* Views */
    .view-section { display: none; flex-grow: 1; flex-direction: column; overflow: hidden; }
    .view-section.active { display: flex; }

    /* Toolbar */
    .toolbar { 
        padding: 8px 16px; background: #292a2d; border-bottom: 1px solid var(--border); 
        display: flex; align-items: center; gap: 12px; flex-shrink: 0; flex-wrap: wrap; 
    }
    
    /* Buttons - Google Style Pill Shape */
    button { 
        cursor: pointer; padding: 6px 16px; font-size: 13px; font-weight: 500;
        border: 1px solid transparent; 
        background: var(--btn-bg); color: var(--text-main); 
        border-radius: 18px; /* Pill shape */
        transition: background 0.2s, box-shadow 0.2s;
    }
    button:hover { background: var(--btn-hover); box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    
    /* Primary Action (Gem) - Google Green */
    button.primary { background: var(--google-green); color: white; border: none; }
    button.primary:hover { background: #188038; box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
    
    button.danger { background: #d93025; color: white; }
    button.danger:hover { background: #b31412; }
    
    /* State Buttons */
    button.locked-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    button.unlocked-btn { background: #1e8e3e; color: #fff; border: 1px solid transparent; }
    
    button:disabled, button.disabled-element { 
        color: #555; background: #2a2b2e; border: 1px solid #333; cursor: not-allowed; pointer-events: none; 
    }
    
    /* Inputs */
    input { 
        background: #35363a; border: 1px solid var(--border); color: #fff; padding: 6px 8px; border-radius: 4px; outline: none;
    }
    input:focus { border-color: var(--google-blue); }

    .week-selector { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); }
    .week-selector input { width: 40px; text-align: center; font-weight: bold; background: transparent; border: none; border-bottom: 2px solid var(--border); border-radius: 0; }
    .week-selector input:focus { border-bottom-color: var(--google-blue); }

    .file-info { margin-left: 10px; color: var(--text-muted); font-style: italic; font-size: 12px; }
    .dirty-indicator { color: #fbbc04; font-weight: bold; display: none; margin-left: 5px; }
    
    .legend-container { 
        font-size: 11px; color: var(--text-muted); margin-left: auto; display: flex; flex-direction: column; 
        align-items: flex-end; gap: 4px; max-width: 500px; 
    }
    .legend-row { display: flex; gap: 10px; align-items: center; }
    .color-box { display: inline-block; width: 10px; height: 10px; border: 1px solid #555; vertical-align: middle; margin-right: 4px; border-radius: 2px; }

    .copy-actions { display: flex; gap: 8px; border-left: 1px solid #555; padding-left: 12px; margin-left: 10px; }
    .autosave-wrapper { display: flex; align-items: center; gap: 6px; font-size: 12px; border-left: 1px solid #555; padding-left: 12px; margin-left: 10px; color: var(--text-muted); }

    /* Update Banner */
    #updateBanner {
        background-color: #fbbc04; color: #202124; border-bottom: 1px solid #e37400;
        padding: 8px; text-align: center; font-weight: bold; display: none;
        animation: slideDown 0.5s ease-out; font-size: 12px;
    }
    @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    #updateBanner button { margin-left: 15px; background: #202124; color: #fff; border: none; padding: 4px 12px; font-size: 11px; }

    /* Overlays */
    .overlay-screen { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); z-index: 100; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
    }
    .overlay-box { 
        background: #303134; color: #fff; padding: 40px; border: 1px solid #5f6368; 
        box-shadow: 0 12px 24px rgba(0,0,0,0.5); text-align: center; border-radius: 8px; width: 320px; 
    }
    .start-btn { display: block; width: 100%; margin: 15px 0; padding: 12px; font-size: 14px; }
    
    #warningModal { background: rgba(0,0,0,0.85); z-index: 200; display: none; }
    .warning-box { 
        background: #303134; color: #fff; padding: 30px; border-radius: 8px; 
        text-align: center; width: 350px; border-top: 4px solid #fbbc04; 
    }
    .warning-timer { font-size: 36px; font-weight: 300; margin: 20px 0; color: #fbbc04; font-family: monospace; }

    /* Tabel Container */
    .sheet-container { flex-grow: 1; overflow: auto; position: relative; background: var(--bg-body); }
    table { border-collapse: collapse; width: max-content; }
    
    th, td { 
        border: 1px solid var(--border); padding: 0 4px; text-align: center; 
        height: 28px; min-width: 35px; color: var(--text-main); 
        box-sizing: border-box;
    }
    
    th { 
        background: var(--bg-header); color: #e8eaed; border-color: var(--border);
        position: sticky; top: 0; z-index: 10; font-weight: 600; font-size: 12px;
    }
    
    /* Sticky Columns - Matching background to prevent see-through */
    /* 1. Kolonne: Checkbox */
    .col-select { 
        position: sticky; 
        left: 0; 
        width: 30px; 
        min-width: 30px; /* Tvinger bredden */
        z-index: 12; 
        background-color: var(--bg-header); 
        border: 1px solid var(--border); 
    }

    /* 2. Kolonne: Togt */
    .col-togt { 
        position: sticky; 
        left: 30px; 
        width: 50px; 
        min-width: 50px; /* Tvinger bredden */
        z-index: 12; 
        background-color: var(--bg-body); 
        border: 1px solid var(--border); 
        font-weight: bold; 
    }

	/* Station kolonne: Fast bredde og '...' n친r der ikke redigeres */
    .col-station { 
        position: sticky; 
        left: 80px; 
        width: 230px; 
        max-width: 230px; /* Vigtig for at begr칝nse teksten */
        z-index: 11; 
        background-color: var(--bg-body); 
        border: 1px solid var(--border); 
        text-align: left; 
        padding-left: 8px;
        
        /* Disse tre linjer sikrer at den kun fylder 칠n linje og viser '...' */
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis;
    }
    
    /* N친r man klikker i cellen (redigering) */
    .col-station:focus {
		left: 80px;
		width: 230px;
        max-width: 230px;
        text-overflow: clip;
        
        /* Behold overflow:hidden -> dette f친r teksten til at 'scrolle' 
           med mark칮ren i stedet for at flyde ud over kanten */
        overflow: hidden; 
        
        /* Vi beholder sticky positionering s친 den ikke hopper */
        position: sticky;
        z-index: 11;
        cursor: text;
		outline: 2px solid var(--google-blue);
        outline-offset: -2px; /* Holder rammen inden for cellen */
    }

/* RETTET: Nu med sticky position og korrekt startsted (310px) */
    .col-nr {
        width: 80px;            
        min-width: 80px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        
        /* Disse linjer manglede f칮r: */
        position: sticky; 
        left: 310px;            /* 110px (Station start) + 200px (Station bredde) */
        z-index: 11; 
        background-color: var(--bg-body); 
        border: 1px solid var(--border); 
    }

    /* RETTET: Flyttet til 390px s친 den ikke ligger oven i Nr */
    .col-link-1 { 
        position: sticky; 
        left: 390px;            /* 310px (Nr start) + 80px (Nr bredde) */
        width: 50px; 
        z-index: 11; 
        background-color: var(--bg-body); 
        border: 1px solid var(--border); 
        font-size: 11px; 
    }

    /* RETTET: Flyttet til 440px */
    .col-link-2 { 
        position: sticky; 
        left: 440px;            /* 390px + 50px */
        width: 50px; 
        z-index: 11; 
        background-color: var(--bg-body); 
        border: 1px solid var(--border);
        font-size: 11px; 
    }
    
    /* RETTET: Flyttet til 490px */
    .col-summary { 
        position: sticky; 
        left: 490px;            /* 440px + 50px */
        width: 60px; 
        z-index: 11; 
        background-color: #3c4043; 
		border: 1px solid var(--border);
        border-right: 2px solid #777; 
        font-weight: bold; 
        color: #fff; 
    }
    /* Sum Columns */
    .col-sum { background-color: #2d2e31; color: #9aa0a6; font-weight: bold; min-width: 30px; border: 1px solid var(--border); font-size: 11px; }

    /* Active Cell Focus - Google Blue Border */
    td:focus { outline: 2px solid var(--google-blue); z-index: 20; border-radius: 1px; }
    
    .togt-cell { color: #fff; text-shadow: 0px 0px 2px rgba(0,0,0,0.8); }
    a.cell-link { text-decoration: none; color: var(--google-blue); font-weight: bold; }
    a.cell-link:hover { text-decoration: underline; }

    .has-note { position: relative; }
    .has-note::after { 
        content: ''; position: absolute; top: 0px; right: 0px; 
        border-style: solid; border-width: 0 6px 6px 0; 
        border-color: transparent #d93025 transparent transparent; 
        pointer-events: none; 
    }

    /* Selection Logic */
		tr.selected .col-select,
		tr.selected .col-togt,
		tr.selected .col-station,
		tr.selected .col-nr,
		tr.selected .col-link-1,
		tr.selected .col-link-2,
		tr.selected .col-summary {
			background-color: #2d333b !important; /* M칮rk gr친/bl친 markering */
			border-top: 1px solid var(--google-blue);
			border-bottom: 1px solid var(--google-blue);
		}

		/* S칮rg for at uge-cellerne IKKE bliver farvet */
		tr.selected td {
			background-color: transparent; 
		}
    
    .row-checkbox { cursor: pointer; width: 14px; height: 14px; margin-top: 6px; accent-color: var(--google-blue); }
    .locked-cell { cursor: default; color: #e8eaed; }

    /* Settings Tab */
    .settings-container { padding: 20px; max-width: 900px; margin: 0 auto; overflow: auto; display: flex; gap: 40px; color: #eee; }
    .settings-col { flex: 1; }
    .settings-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .settings-table th, .settings-table td { padding: 8px; border: 1px solid #5f6368; text-align: left; color: #eee; }
    .settings-table th { background: #35363a; }
    .settings-table td input { background: #202124; color: #fff; border: 1px solid #5f6368; width: 100%; box-sizing: border-box; }
    .settings-table td input:focus { border-color: var(--google-blue); }
    input[type="color"] { width: 40px; height: 30px; border: none; cursor: pointer; padding: 0; background: none; }


/* --- MOBIL TILPASNING (OPDATERET BREDDE) --- */
    @media screen and (max-width: 768px) {
        
        /* 1. Skjul alt 'st칮j' */
        .nav-tabs, 
        .col-select, .col-nr, .col-summary, .col-sum,
        #btnLock, #btnAddRow, #btnSave,#btnCloseTop,
        .copy-actions, .autosave-wrapper, .legend-container, .file-info, .dirty-indicator, 
        .col-station:focus
        {
            display: none !important;
        }

        /* 2. Ops칝tning af Tabel til fuld bredde */
        .sheet-container {
            margin-bottom: 70px;
            overflow-x: hidden;
        }
        
        /* VIGTIGT: table-layout: fixed tvinger browseren til at lytte til vores %-bredder */
        table {
            width: 100% !important; 
            table-layout: fixed !important; 
            border-collapse: collapse;
        }

        /* 3. Definer bredder p친 OVERSKRIFTERNE (th) */
        /* Togt: 7% (ca 1/6) */
        th.col-togt { width: 7% !important; }
        
        /* Station: 40% (lidt over 2/6 - giver god plads til tekst) */
        th.col-station { width: 40% !important; }
        
        /* Links: 20% tilsammen (7.5% hver) - rigeligt til et ikon */
        th.col-link-1 { width: 12.5% !important; }
        th.col-link-2 { width: 12.5% !important; }
        
        /* Uge: 18% (Resten - vigtig at v칝re bred nok til at ramme) */
        /* Vi rammer den overskrift der IKKE er skjult */
        th:not(.mobile-hidden):not(.col-togt):not(.col-station):not(.col-link-1):not(.col-link-2) {
             width: 18% !important;
        }

        /* 4. Juster cellernes indhold (td) */
        .col-togt, .col-station, .col-link-1, .col-link-2 {
            position: static !important; /* Fjern sticky */
            padding: 0 4px !important;
            box-sizing: border-box;
        }

        /* Togt Styling */
        .col-togt { font-size: 10px; }

        /* Station Styling */
        .col-station {
            font-size: 11px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Prikker hvis teksten er for lang */
        }

        /* Links Styling */
        .col-link-1, .col-link-2 { font-size: 9px; padding: 0 !important; }
        .col-link-1 input, .col-link-2 input { display:none; } /* Skjul input felter i links p친 mobil */
        /* Hvis du vil vise links som tekst/link i stedet for input: */
        .col-link-1::before { content: '游댕'; } 
        .col-link-2::before { content: '游댕'; } 

        /* Skjul uger der ikke er den aktuelle */
        .mobile-hidden { display: none !important; }

        /* 5. Toolbar & Menuer */
        .toolbar {
            background: #202124;
            padding: 10px;
            justify-content: center;
            border-bottom: 1px solid #5f6368;
        }
        .week-selector {
            width: 100%;
            justify-content: space-between;
            font-size: 16px;
            color: #fff;
            background: #3c4043;
            padding: 8px 20px;
            border-radius: 20px;
        }
        .week-selector input { font-size: 16px; width: 50px; text-align:center; border:none; background:transparent; color:#fff; }

        /* Bundmenu */
        #mobileBottomBar {
            display: flex !important;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #202124;
            padding: 10px;
            gap: 10px;
            border-top: 1px solid #5f6368;
            z-index: 9999;
        }

        /* Generel h칮jde */
        th, td { height: 45px; } /* Lidt h칮jere celler for nemmere tryk */
    }
		
</style>
</head>
<body>

<div id="multiTabWarning" class="overlay-screen" style="display:none; z-index:99999; background: #202124;">
    <div class="warning-box" style="border-top: 4px solid #d93025;">
        <h2 style="color:#d93025;">Siden er allerede 친ben!</h2>
        <p>Du har allerede dette v칝rkt칮j 친bent i en anden fane eller et andet vindue.</p>
        <p>For at undg친 datatab er denne fane blevet deaktiveret.</p>
        <div style="margin-top:20px;">
            <button onclick="window.close()" class="primary" style="background:#5f6368;">Luk denne fane</button>
            <br><br>
            <button onclick="forceOpen()" style="background:transparent; border:none; color:#5f6368; text-decoration:underline; font-size:11px; cursor:pointer;">
                Jeg er ligeglad, brug denne fane alligevel (Risiko for fejl!)
            </button>
        </div>
    </div>
</div>

<div id="updateBanner">
    OBS: En kollega har netop gemt en ny version af filen! 
    <button onclick="window.location.reload()">Genindl칝s</button>
</div>

<div id="startScreen" class="overlay-screen">
    <div class="overlay-box">
        <h2>Planl칝gning</h2>
        <button id="btnReloadLast" class="primary start-btn" style="display:none;">Gen친bn seneste fil</button>
        <button id="btnStartOpen" class="start-btn">칀bn eksisterende fil</button>
        <button id="btnStartNew" class="start-btn">Opret ny fil</button>
    </div>
</div>

<div id="warningModal" class="overlay-screen">
    <div class="warning-box">
        <h2>Er du der stadig?</h2>
        <p>Siden har v칝ret inaktiv i 9 minutter.</p>
        <p>For din sikkerhed lukker siden og gemmer om:</p>
        <div id="countdownDisplay" class="warning-timer">60</div>
        <button class="primary start-btn" onclick="continueSession()">Jeg er her stadig (Forts칝t)</button>
    </div>
</div>

<div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('plan')">Planl칝gning</button>
    <button id="tabSettings" class="nav-tab" onclick="switchTab('settings')">Indstillinger</button>
</div>

<div id="view-plan" class="view-section active">
    <div class="toolbar">
        <button id="btnSave" title="Gem (Ctrl+S)" class="primary">Gem</button>
        <button id="btnCloseTop" onclick="attemptClose()">Luk</button>
        <button id="btnLock" class="locked-btn" onclick="toggleLock()" title="Klik for at redigere">L친st (Visning)</button>
        
        <div class="week-selector">
            <span>Uge</span>
            <input type="number" id="weekInput" min="1" max="53" value="1" onchange="updateSummaryColumn()">
        </div>
        
        <div class="autosave-wrapper">
            <input type="checkbox" id="chkAutoSave" checked title="Gem automatisk hvert minut">
            <label for="chkAutoSave" title="Gem automatisk hvert minut">Auto-gem</label>
        </div>

        <div class="copy-actions">
            <button onclick="copyData('text')" title="Kopier navn, nr og koder som tekststreng">Kopier Tekst</button>
            <button onclick="copyData('excel')" title="God til Excel">Kopier Excel</button>
        </div>

        <span id="currentFileName" class="file-info">Ingen fil</span>
        <span id="dirtyIndicator" class="dirty-indicator" title="Ugemte 칝ndringer">*</span>

        <button id="btnAddRow" onclick="addRow()" style="margin-left: 20px;">+ R칝kke</button>
        
        <div class="legend-container">
            <div class="legend-row" id="legendCodes"></div>
            <div class="legend-row" id="legendColors"></div>
            <div class="legend-row" style="margin-top:2px; font-style:italic;">Tryk 'n' for note</div>
        </div>
    </div>

    <div class="sheet-container">
        <table id="grid">
            <thead>
                <tr id="headerRow">
                    <th class="col-select"><input type="checkbox" onclick="toggleAll(this)"></th>
                    <th class="col-togt">Togt</th>
                    <th class="col-station">Station</th>
                    <th class="col-nr">Nr.</th>
                    <th class="col-link-1">VanDa</th>
                    <th class="col-link-2">WMS</th>
                    <th class="col-summary" id="summaryHeader">Uge ?</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<div id="view-settings" class="view-section">
    <div class="settings-container">
        <div class="settings-col">
            <h3>Koder</h3>
            <table class="settings-table">
                <thead><tr><th>Tast</th><th>Vis</th><th>Betydning</th><th></th></tr></thead>
                <tbody id="settingsBodyCodes"></tbody>
            </table>
            <button class="primary" onclick="addNewCode()">+ Ny kode</button>
        </div>
        <div class="settings-col">
            <h3>Farver & Genveje</h3>
            <table class="settings-table">
                <thead><tr><th>Farve</th><th>Status</th><th>Genvej (tast / dblclick)</th><th></th></tr></thead>
                <tbody id="settingsBodyColors"></tbody>
            </table>
            <button class="primary" onclick="addNewColor()">+ Ny status</button>
        </div>
    </div>
</div>

<div id="mobileBottomBar" style="display:none;">
    <button onclick="attemptClose()" style="background:#d93025; color:white; flex:1; padding:15px; border-radius:8px; border:none; font-size:14px;">Luk</button>
    <button id="btnMobileSave" onclick="performSave(false)" style="background:#1e8e3e; color:white; flex:2; padding:15px; border-radius:8px; border:none; font-size:14px; font-weight:bold;">Gem</button>
</div>

<script>
	// --- FORHINDRE FLERE FANER ---
    const channelName = 'plan_tool_channel';
    const bc = new BroadcastChannel(channelName);

    // 1. Lyt efter beskeder fra andre faner
    bc.onmessage = (event) => {
        // Hvis en ny fane sp칮rger "er nogen her?", svarer vi "ja"
        if (event.data === 'new_tab_opening') {
            bc.postMessage('tab_already_open');
        }
        // Hvis en eksisterende fane siger "jeg er her", s친 l친ser vi os selv
        if (event.data === 'tab_already_open') {
            document.getElementById('multiTabWarning').style.display = 'flex';
        }
    };

    // 2. Fort칝l verden at vi 친bner (sp칮rg om andre er der)
    bc.postMessage('new_tab_opening');

    // Funktion til at tvinge 친bning (hvis brugeren insisterer)
    function forceOpen() {
        document.getElementById('multiTabWarning').style.display = 'none';
        // Vi fort칝ller evt. andre faner at DE skal lukke (valgfrit)
        // bc.postMessage('tab_already_open'); 
    }

    const UGER = 53;
    const TOGT_PALETTE = ['#882e36','#8c5c2e','#8c862e','#4a8c38','#2e5c8c','#6a2e8c','#8c2e75','#5a6838','#386862','#4c526d','#8c4a4e','#8c625e','#8c7a6b','#5a6838','#386862','#4c526d','#7d7536','#6d5a6d','#8c322d','#387d38']; 
    const DEFAULT_CODES = [{ key: 'q', disp: 'Q', desc: 'Vandf칮ring' }, { key: 'h', disp: 'H', desc: 'Skalap칝l' }, { key: 'k', disp: 'K', desc: 'Kemi' }, { key: 's', disp: 's', desc: 'Salinitet' }, { key: 'f', disp: 'f', desc: 'Jern' }, { key: 'a', disp: 'a', desc: 'Alkalinitet' }];
    const DEFAULT_STATUS = [
        { color: '#202124', desc: 'Ingen status', shortcut: '' },
        { color: '#3c7042', desc: 'Pr칮vetaget', shortcut: '1' }, 
        { color: '#8a3c3c', desc: 'T칮rlagt', shortcut: 'dblclick' }, 
        { color: '#3c5a8a', desc: 'Modtaget', shortcut: '' }
    ];

    let appData = { settings: JSON.parse(JSON.stringify(DEFAULT_CODES)), statusSettings: JSON.parse(JSON.stringify(DEFAULT_STATUS)), rows: [] };
    let fileHandle = null, displayWeek = 1, selectedIndices = new Set(), isLocked = true;
    let hasUnsavedChanges = false;
    let lastFileModTime = 0;

    const AUTO_SAVE_INTERVAL_MS = 60000;
    const INACTIVITY_WARNING_MS = 9 * 60 * 1000; 
    const INACTIVITY_FINAL_MS = 60 * 1000; 
    const POLL_INTERVAL_MS = 10000;

    let inactivityTimer = null, countdownTimer = null, countdownInterval = null;

    function getCurrentWeek() { const d = new Date(); const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1)); return Math.ceil((((date - yearStart) / 86400000) + 1) / 7); }
    displayWeek = getCurrentWeek();
    document.getElementById('weekInput').value = displayWeek;
    document.getElementById('summaryHeader').innerText = "Uge " + displayWeek;

    const headerRow = document.getElementById('headerRow');
    // Slet gamle uge-headers hvis vi k칮rer render igen, eller bare ved start:
    // (Note: Din kode genererer dem kun 칠n gang ved start, s친 erstat den blok)
    
    for (let i = 1; i <= UGER; i++) { 
        let th = document.createElement('th'); 
        th.innerText = i; 
        
        // --- NYT: Skjul p친 mobil hvis ikke aktuel uge ---
        // Vi opdaterer dette dynamisk i updateSummaryColumn() i stedet for her, 
        // da headeren kun laves 칠n gang. 
        // S친 giv dem et ID eller en klasse s친 vi kan finde dem.
        th.className = 'th-week-' + i; // Giv unik klasse
        // -----------------------------------------------

        if(i === displayWeek) { 
            th.style.backgroundColor = "#444"; 
            th.style.borderBottom = "2px solid #8ab4f8"; 
        } 
        headerRow.appendChild(th); 
    }
    updateLegend();

    setInterval(() => { const chk = document.getElementById('chkAutoSave'); if (chk && chk.checked && hasUnsavedChanges && fileHandle) performAutoSave(); }, AUTO_SAVE_INTERVAL_MS);
    setInterval(checkForExternalUpdates, POLL_INTERVAL_MS);

    async function checkForExternalUpdates() {
        if (!fileHandle) return;
        try {
            const fileOnDisk = await fileHandle.getFile();
            if (fileOnDisk.lastModified > lastFileModTime + 2000) { document.getElementById('updateBanner').style.display = 'block'; }
        } catch (e) { console.log("Fejl i poll:", e); }
    }

    function resetInactivityTimer() { if(document.getElementById('warningModal').style.display === 'flex') return; clearTimeout(inactivityTimer); inactivityTimer = setTimeout(showInactivityWarning, INACTIVITY_WARNING_MS); }
    function setupActivityListeners() { window.addEventListener('mousemove', resetInactivityTimer); window.addEventListener('keydown', resetInactivityTimer); window.addEventListener('click', resetInactivityTimer); resetInactivityTimer(); }
    function showInactivityWarning() {
        const modal = document.getElementById('warningModal'); modal.style.display = 'flex';
        let secondsLeft = 60; document.getElementById('countdownDisplay').innerText = secondsLeft;
        countdownInterval = setInterval(() => { secondsLeft--; document.getElementById('countdownDisplay').innerText = secondsLeft; if(secondsLeft <= 0) clearInterval(countdownInterval); }, 1000);
        countdownTimer = setTimeout(performAutoClose, INACTIVITY_FINAL_MS);
    }
    function continueSession() { clearTimeout(countdownTimer); clearInterval(countdownInterval); document.getElementById('warningModal').style.display = 'none'; resetInactivityTimer(); }
    async function performAutoClose() { clearInterval(countdownInterval); document.getElementById('warningModal').innerHTML = '<div class="warning-box"><h2>Auto-gemmer...</h2></div>'; await performSave(true); document.body.innerHTML = `<div style="display:flex; height:100vh; align-items:center; justify-content:center; flex-direction:column; background:#202124; color:#e8eaed;"><div style="background:#303134; padding:40px; border-radius:8px; border:1px solid #5f6368; text-align:center;"><h1 style="color:#fff;">Session Afsluttet</h1><p>Du var inaktiv i 10 minutter.</p><p style="color:#1e8e3e; font-weight:bold;">Dine data er blevet gemt.</p><button onclick="window.location.reload()" style="padding:10px 20px; cursor:pointer; font-size:16px; background:#8ab4f8; border:none; color:#202124; border-radius:18px;">Log ind igen</button></div></div>`; window.close(); }

    const dbName = 'PlanDB_MultiUser';
    function getDB() { return new Promise((res, rej) => { const r = indexedDB.open(dbName, 1); r.onupgradeneeded = e => e.target.result.createObjectStore('settings'); r.onsuccess = e => res(e.target.result); r.onerror = e => rej(e); }); }
    async function saveHandle(handle) { const db = await getDB(); const tx = db.transaction('settings', 'readwrite'); tx.objectStore('settings').put(handle, 'lastFileHandle'); }
    async function getLastHandle() { const db = await getDB(); return new Promise(res => { const tx = db.transaction('settings', 'readonly'); const r = tx.objectStore('settings').get('lastFileHandle'); r.onsuccess = () => res(r.result); }); }

    window.addEventListener('DOMContentLoaded', async () => {
        setupActivityListeners(); 
        const lastHandle = await getLastHandle();
        if (lastHandle) {
            const btn = document.getElementById('btnReloadLast'); btn.style.display = 'block'; btn.innerText = `Gen친bn "${lastHandle.name}"`;
            btn.onclick = async () => { fileHandle = lastHandle; if (await verifyPermission(fileHandle, true)) { await loadFromFile(); document.getElementById('startScreen').style.display = 'none'; } };
        }
        updateLockButton();
    });

    document.getElementById('btnStartOpen').onclick = async () => { try { [fileHandle] = await window.showOpenFilePicker({ types: [{ description: 'JSON Plan', accept: { 'application/json': ['.json'] } }] }); await saveHandle(fileHandle); await loadFromFile(); document.getElementById('startScreen').style.display = 'none'; } catch (e) {} };
    document.getElementById('btnStartNew').onclick = async () => { appData.settings = JSON.parse(JSON.stringify(DEFAULT_CODES)); appData.statusSettings = JSON.parse(JSON.stringify(DEFAULT_STATUS)); appData.rows = []; addRow(); updateLegend(); document.getElementById('startScreen').style.display = 'none'; document.getElementById('currentFileName').innerText = "Ny (Ikke gemt)"; markDirty(false); };

    async function verifyPermission(handle, withWrite) { const opts = withWrite ? { mode: 'readwrite' } : {}; if ((await handle.queryPermission(opts)) === 'granted') return true; if ((await handle.requestPermission(opts)) === 'granted') return true; return false; }
    
    async function loadFromFile() {
        const file = await fileHandle.getFile(); lastFileModTime = file.lastModified; 
        const text = await file.text();
        document.getElementById('currentFileName').innerText = file.name;
        document.getElementById('updateBanner').style.display = 'none';
        try { 
            const json = JSON.parse(text);
            if (Array.isArray(json)) { appData.rows = json; appData.settings = JSON.parse(JSON.stringify(DEFAULT_CODES)); appData.statusSettings = JSON.parse(JSON.stringify(DEFAULT_STATUS)); } 
            else { 
                appData = json; 
                if(!appData.settings) appData.settings = JSON.parse(JSON.stringify(DEFAULT_CODES)); 
                if(!appData.statusSettings) appData.statusSettings = JSON.parse(JSON.stringify(DEFAULT_STATUS));
                if(!appData.rows) appData.rows = [];
                appData.statusSettings.forEach((s, idx) => { if(!s.shortcut) s.shortcut = (idx === 2 ? 'dblclick' : ''); });
            }
        } catch (e) { appData.rows = []; }
        if (appData.rows.length === 0) addRow();
        markDirty(false); updateLegend(); render();
    }

    function markDirty(isDirty) { 
        hasUnsavedChanges = isDirty; 
        const ind = document.getElementById('dirtyIndicator'); 
        const btnDesktop = document.getElementById('btnSave'); 
        const btnMobile = document.getElementById('btnMobileSave'); // NYT
        
        if (isDirty) { 
            if(ind) ind.style.display = 'inline'; 
            document.title = "* Planl칝gning 2026"; 
            if(btnDesktop) { btnDesktop.style.background = "#fbbc04"; btnDesktop.style.color = "#000"; btnDesktop.innerText = "Gem*"; }
            if(btnMobile) { btnMobile.style.background = "#fbbc04"; btnMobile.style.color = "#000"; btnMobile.innerText = "Gem 칝ndringer*"; } // NYT
        } else { 
            if(ind) ind.style.display = 'none'; 
            document.title = "Planl칝gning 2026"; 
            if(btnDesktop) { btnDesktop.style.background = "#1e8e3e"; btnDesktop.style.color = "#fff"; btnDesktop.innerText = "Gem"; }
            if(btnMobile) { btnMobile.style.background = "#1e8e3e"; btnMobile.style.color = "#fff"; btnMobile.innerText = "Gem"; } // NYT
        } 
    }

    async function performSave(silent = false) {
        if (!fileHandle) { try { fileHandle = await window.showSaveFilePicker({ suggestedName: 'plan.json' }); await saveHandle(fileHandle); } catch (e) { return false; } }
        try {
            const fileOnDisk = await fileHandle.getFile();
            if (fileOnDisk.lastModified > lastFileModTime + 2000) { if(!silent) alert("KONFLIKT!\n\nEn anden har 칝ndret filen siden du 친bnede den.\nGemning afbrudt."); return false; }
            const writable = await fileHandle.createWritable(); await writable.write(JSON.stringify(appData)); await writable.close();
            const newFile = await fileHandle.getFile(); lastFileModTime = newFile.lastModified;
            document.getElementById('currentFileName').innerText = fileHandle.name; markDirty(false);
            const btn = document.getElementById('btnSave'); if(!silent) { btn.innerText = "Gemt!"; setTimeout(() => { btn.innerText = "Gem"; }, 1000); }
            return true;
        } catch (e) { if(!silent) alert("Fejl: " + e); return false; }
    }
    async function performAutoSave() { const btn = document.getElementById('btnSave'); const originalText = btn.innerText; btn.innerText = "Gemmer..."; const success = await performSave(true); if(success) setTimeout(() => { btn.innerText = originalText; }, 1000); }
    document.getElementById('btnSave').onclick = async () => { await performSave(false); };
    document.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); performSave(false); } });
    async function attemptClose() { if (hasUnsavedChanges) { if (confirm("Du har ugemte 칝ndringer!\n\nTryk OK for at GEMME og lukke.\nTryk Annuller for at lukke UDEN at gemme.")) { const saved = await performSave(false); if (saved) window.location.reload(); } else { window.location.reload(); } } else { window.location.reload(); } }
    window.addEventListener('beforeunload', (e) => { if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; } });

    function switchTab(tabName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabName).classList.add('active');
        const buttons = document.querySelectorAll('.nav-tab');
        if(tabName === 'plan') { buttons[0].classList.add('active'); updateLegend(); render(); }
        if(tabName === 'settings') { if(isLocked) return switchTab('plan'); buttons[1].classList.add('active'); renderSettingsTables(); }
    }
    function renderSettingsTables() {
        const tbodyCodes = document.getElementById('settingsBodyCodes'); tbodyCodes.innerHTML = '';
        appData.settings.forEach((code, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="text" maxlength="1" value="${code.key}" onchange="updateSet(0, ${idx}, 'key', this.value)"></td><td><input type="text" maxlength="1" value="${code.disp}" onchange="updateSet(0, ${idx}, 'disp', this.value)"></td><td><input type="text" value="${code.desc}" onchange="updateSet(0, ${idx}, 'desc', this.value)"></td><td><button class="danger" onclick="removeSet(0, ${idx})">Slet</button></td>`;
            tbodyCodes.appendChild(tr);
        });
        const tbodyColors = document.getElementById('settingsBodyColors'); tbodyColors.innerHTML = '';
        appData.statusSettings.forEach((stat, idx) => {
            const tr = document.createElement('tr');
            const delBtn = idx === 0 ? '' : `<button class="danger" onclick="removeSet(1, ${idx})">Slet</button>`;
            const shortcutVal = stat.shortcut || '';
            tr.innerHTML = `<td><input type="color" value="${stat.color}" onchange="updateSet(1, ${idx}, 'color', this.value)"></td><td><input type="text" value="${stat.desc}" onchange="updateSet(1, ${idx}, 'desc', this.value)"></td><td><input type="text" value="${shortcutVal}" placeholder="fx '1'" onchange="updateSet(1, ${idx}, 'shortcut', this.value)"></td><td>${delBtn}</td>`;
            tbodyColors.appendChild(tr);
        });
    }
    function updateSet(type, idx, field, val) { if(type === 0) { if(field === 'key') val = val.toLowerCase(); appData.settings[idx][field] = val; } else { appData.statusSettings[idx][field] = val; } markDirty(true); }
    function addNewCode() { appData.settings.push({ key: '', disp: '', desc: '' }); renderSettingsTables(); markDirty(true); }
    function addNewColor() { appData.statusSettings.push({ color: '#cccccc', desc: 'Ny status', shortcut: '' }); renderSettingsTables(); markDirty(true); }
    function removeSet(type, idx) { if(!confirm("Er du sikker?")) return; if(type === 0) appData.settings.splice(idx, 1); else appData.statusSettings.splice(idx, 1); renderSettingsTables(); markDirty(true); }
    function updateLegend() {
        const codeParts = appData.settings.map(c => `${c.disp}=${c.desc}`); document.getElementById('legendCodes').innerText = "Koder: " + codeParts.join(', ');
        const colorContainer = document.getElementById('legendColors'); colorContainer.innerHTML = 'Farver: ';
        appData.statusSettings.forEach((s, i) => { if (i === 0 && s.desc.toLowerCase().includes('ingen')) return; const span = document.createElement('span'); span.style.marginRight = "8px"; span.innerHTML = `<span class="color-box" style="background:${s.color}"></span>${s.desc}`; colorContainer.appendChild(span); });
    }

    function toggleLock() { isLocked = !isLocked; updateLockButton(); render(); }
    function updateLockButton() {
        const btn = document.getElementById('btnLock'), btnAdd = document.getElementById('btnAddRow'), tabSet = document.getElementById('tabSettings');
        if (isLocked) { btn.innerText = "L친st (Visning)"; btn.className = "locked-btn"; btnAdd.disabled = true; btnAdd.classList.add('disabled-element'); tabSet.classList.add('disabled-element'); } 
        else { btn.innerText = "Rediger (Aktiv)"; btn.className = "unlocked-btn"; btnAdd.disabled = false; btnAdd.classList.remove('disabled-element'); tabSet.classList.remove('disabled-element'); }
    }
    function updateSummaryColumn() { const input = document.getElementById('weekInput'); let val = parseInt(input.value); if(val < 1) val = 1; if(val > UGER) val = UGER; displayWeek = val; document.getElementById('summaryHeader').innerText = "Uge " + displayWeek; render(); }
    function getTogtColor(text) { if (!text) return '#fff'; let hash = 0; for (let i = 0; i < text.length; i++) { hash = text.charCodeAt(i) + ((hash << 5) - hash); } return TOGT_PALETTE[Math.abs(hash) % TOGT_PALETTE.length]; }
    function toggleRow(idx) { if (selectedIndices.has(idx)) selectedIndices.delete(idx); else selectedIndices.add(idx); render(); }
    function toggleAll(checkbox) { if (checkbox.checked) appData.rows.forEach((_, idx) => selectedIndices.add(idx)); else selectedIndices.clear(); render(); }

    async function copyData(mode) {
        if (selectedIndices.size === 0) return alert("V칝lg mindst 칠n r칝kke f칮rst.");
        const sortedIndices = Array.from(selectedIndices).sort((a, b) => a - b);
        if (mode === 'excel') {
            let htmlContent = `<table border="1" style="border-collapse: collapse;"><thead><tr><th>Togt</th><th>Station</th><th>Nr</th><th>VanDa</th><th>WMS</th><th>Uge ${displayWeek}</th></tr></thead><tbody>`;
            sortedIndices.forEach(idx => {
                const row = appData.rows[idx];
                const station = row.station || ""; const nr = row.nr || ""; const togt = row.togt || "";
                const kode = (row.weeks && row.weeks[displayWeek-1]) ? row.weeks[displayWeek-1].val : "";
                const vandaLink = row.vandaLink ? `<a href="${row.vandaLink}">VanDa</a>` : "";
                const wmsLink = row.wmsLink ? `<a href="${row.wmsLink}">WMS</a>` : "";
                htmlContent += `<tr><td>${togt}</td><td>${station}</td><td>${nr}</td><td>${vandaLink}</td><td>${wmsLink}</td><td>${kode}</td></tr>`;
            });
            htmlContent += `</tbody></table>`;
            const blobHtml = new Blob([htmlContent], { type: "text/html" }); const blobText = new Blob([`Kopieret ${sortedIndices.length} r칝kker`], { type: "text/plain" });
            const data = [new ClipboardItem({ "text/html": blobHtml, "text/plain": blobText })];
            try { await navigator.clipboard.write(data); alert(`Kopieret (Excel)!`); } catch (err) { alert("Fejl: " + err); }
        }
        else if (mode === 'text') {
            const parts = sortedIndices.map(idx => {
                const row = appData.rows[idx];
                const station = row.station || ""; const nr = row.nr || "";
                const kode = (row.weeks && row.weeks[displayWeek-1]) ? row.weeks[displayWeek-1].val : "";
                return `${station} ${nr} ${kode}`.replace(/\s+/g, ' ').trim();
            });
            const resultString = parts.join(", ");
            try { await navigator.clipboard.writeText(resultString); alert("Tekst kopieret!"); } catch (err) { alert("Fejl: " + err); }
        }
    }

	function handlePaste(e, type) {
		e.preventDefault(); // Stop browseren i at inds칝tte HTML/Excel-koder
		
		let text = (e.clipboardData || window.clipboardData).getData('text');

		if (type === 'nr') {
			text = text.replace(/\D/g, '').substring(0, 8);
		} else if (type === 'station') {
			text = text.replace(/(\r\n|\n|\r)/gm, " ");
		}
		document.execCommand('insertText', false, text);
	}
	
		// H친ndterer paste af B칀DE enkelt celler og st칮rre omr친der (fra Excel)
	function handleWeekPaste(e, startRowIdx, startWeekIdx) {
		if (isLocked) return;
		e.preventDefault();
		
		// 1. Hent data
		const clipboardText = (e.clipboardData || window.clipboardData).getData('text');
		if (!clipboardText) return;

		// 2. Opdel i r칝kker (Excel bruger linjeskift)
		// Vi fjerner tomme r칝kker til sidst, som Excel nogle gange tager med
		const rows = clipboardText.split(/\r\n|\n|\r/).filter(row => row.trim() !== '');

		let changesMade = false;

		// 3. Gennemg친 hver r칝kke fra clipboardet
		rows.forEach((rowStr, rOffset) => {
			const targetRowIdx = startRowIdx + rOffset;
			
			// Stop hvis vi er n친et ud over antallet af r칝kker i systemet
			if (targetRowIdx >= appData.rows.length) return;

			// Opdel r칝kken i kolonner (Excel bruger tabulator '\t')
			const cols = rowStr.split('\t');

			cols.forEach((colVal, wOffset) => {
				const targetWeekIdx = startWeekIdx + wOffset;

				// Stop hvis vi er n친et ud over uge 53 (eller hvor mange uger du har)
				if (targetWeekIdx >= UGER) return;

				// 4. Validering (Samme logik som f칮r: Kun kendte koder)
				let validatedVal = "";
				for (let char of colVal) {
					// Tjek om bogstavet findes i indstillingerne
					const setting = appData.settings.find(s => 
						(s.disp && s.disp.toLowerCase() === char.toLowerCase()) || 
						(s.key && s.key.toLowerCase() === char.toLowerCase())
					);
					if (setting) {
						validatedVal += setting.disp;
					}
				}

				// 5. Opdater data-modellen
				if (!appData.rows[targetRowIdx].weeks) appData.rows[targetRowIdx].weeks = {};
				if (!appData.rows[targetRowIdx].weeks[targetWeekIdx]) {
					appData.rows[targetRowIdx].weeks[targetWeekIdx] = { val: '', stat: 0 };
				}

				// Kun opdater hvis der faktisk er en 칝ndring (eller det er en tom streng der skal slette)
				// Vi tillader at overskrive med tom streng, hvis man paster tomme celler
				appData.rows[targetRowIdx].weeks[targetWeekIdx].val = validatedVal;
				changesMade = true;
			});
		});

		// 6. Gem og optegn hele tabellen p친 ny, hvis der skete 칝ndringer
		if (changesMade) {
			markDirty(true);
			render(); 
		}
	}
	
	// --- MOBIL FUNKTIONALITET ---
    let currentMobileTarget = null; // Gemmer hvilken celle vi redigerer

    function isMobile() {
        return window.innerWidth <= 768;
    }

    function handleCellClick(e, rIdx, wIdx) {
        if (isMobile()) {
            // P친 mobil: 칀bn menu i stedet for at fokusere/tastatur
            e.preventDefault(); // Stop tastatur
            document.activeElement.blur(); // Fjern fokus
            openMobileMenu(rIdx, wIdx);
        } else {
            // P친 desktop: Normal opf칮rsel (fokus)
            e.target.focus();
        }
    }

    function openMobileMenu(rIdx, wIdx) {
        currentMobileTarget = { r: rIdx, w: wIdx };
        
        // Vi beh칮ver ikke l칝ngere hente tekst-v칝rdien, da feltet er v칝k
        
        const container = document.getElementById('mobileStatusOptions');
        container.innerHTML = '';
        
        appData.statusSettings.forEach((stat, idx) => {
            const btn = document.createElement('button');
            btn.style.width = "40px";
            btn.style.height = "40px";
            btn.style.borderRadius = "50%";
            btn.style.border = "2px solid #5f6368";
            btn.style.background = stat.color;
            btn.style.cursor = "pointer";
            
            // Hvis det er 'Ingen status' (index 0)
            if (idx === 0) { 
                btn.innerText = "X"; 
                btn.style.color = "#fff";
                btn.style.background = "transparent";
            }

            btn.onclick = () => {
                setMobileStatus(idx);
            };
            container.appendChild(btn);
        });

        document.getElementById('mobileActionMenu').style.display = 'flex';
    }

    function closeMobileMenu() {
        document.getElementById('mobileActionMenu').style.display = 'none';
        currentMobileTarget = null;
    }

    function setMobileStatus(statIdx) {
        if (!currentMobileTarget) return;
        const { r, w } = currentMobileTarget;
        
        if (!appData.rows[r].weeks) appData.rows[r].weeks = {};
        if (!appData.rows[r].weeks[w]) appData.rows[r].weeks[w] = { val: '', stat: 0 };

        appData.rows[r].weeks[w].stat = statIdx;
        markDirty(true);
        render();
        closeMobileMenu();
    }

    function saveMobileInput() {
        if (!currentMobileTarget) return;
        const { r, w } = currentMobileTarget;
        const val = document.getElementById('mobileTextInput').value;

        if (!appData.rows[r].weeks) appData.rows[r].weeks = {};
        if (!appData.rows[r].weeks[w]) appData.rows[r].weeks[w] = { val: '', stat: 0 };

        appData.rows[r].weeks[w].val = val;
        markDirty(true);
        render();
        closeMobileMenu();
    }
	
    function render() {
		// --- NYT: Opdater header synlighed ---
        for (let i = 1; i <= UGER; i++) {
            const th = document.querySelector('.th-week-' + i);
            if (th) {
                if (i !== displayWeek) {
                    th.classList.add('mobile-hidden');
                } else {
                    th.classList.remove('mobile-hidden');
                }
            }
        }
        // -------------------------------------
        const tbody = document.getElementById('tbody'); tbody.innerHTML = '';
        const headerRow = document.getElementById('headerRow');
        while (headerRow.children.length > 60) { headerRow.removeChild(headerRow.lastChild); }
        if (!isLocked) { appData.settings.forEach(setting => { let th = document.createElement('th'); th.className = 'col-sum'; th.innerText = "풖 " + setting.disp; headerRow.appendChild(th); }); }
        const ths = headerRow.children; for(let i=7; i < 60; i++) { 
            ths[i].style.backgroundColor = (i - 6 === displayWeek) ? "#3c4043" : "#35363a"; 
            if(i - 6 === displayWeek) ths[i].style.borderBottom = "2px solid #8ab4f8";
            else ths[i].style.borderBottom = "1px solid #5f6368";
        }

        appData.rows.forEach((row, rIdx) => {
            const tr = document.createElement('tr');
            if (selectedIndices.has(rIdx)) tr.className = 'selected';
            const tdCheck = document.createElement('td'); tdCheck.className = 'col-select';
            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'row-checkbox'; chk.checked = selectedIndices.has(rIdx);
            chk.onclick = (e) => { e.stopPropagation(); toggleRow(rIdx); };
            tdCheck.appendChild(chk); tr.appendChild(tdCheck);

            const togtTd = createMetaCell(rIdx, 'togt', row.togt, 'col-togt togt-cell');
            togtTd.style.backgroundColor = getTogtColor(row.togt);
            togtTd.oninput = (e) => { appData.rows[rIdx].togt = e.target.innerText; e.target.style.backgroundColor = getTogtColor(e.target.innerText); markDirty(true); };
            tr.appendChild(togtTd);

            tr.appendChild(createMetaCell(rIdx, 'station', row.station, 'col-station'));
            tr.appendChild(createMetaCell(rIdx, 'nr', row.nr, 'col-nr'));

            const tdVanda = document.createElement('td'); tdVanda.className = 'col-link-1';
            if (isLocked) { if(row.vandaLink) tdVanda.innerHTML = `<a href="${row.vandaLink}" target="_blank" class="cell-link" onclick="event.stopPropagation()">VanDa</a>`; } 
            else { const inp = document.createElement('input'); inp.type = "text"; inp.value = row.vandaLink || ""; inp.placeholder = "URL..."; inp.style.width = "90%"; inp.oninput = (e) => { appData.rows[rIdx].vandaLink = e.target.value; markDirty(true); }; inp.onclick = (e) => e.stopPropagation(); tdVanda.appendChild(inp); }
            tr.appendChild(tdVanda);

            const tdWms = document.createElement('td'); tdWms.className = 'col-link-2';
            if (isLocked) { if(row.wmsLink) tdWms.innerHTML = `<a href="${row.wmsLink}" target="_blank" class="cell-link" onclick="event.stopPropagation()">WMS</a>`; } 
            else { const inp = document.createElement('input'); inp.type = "text"; inp.value = row.wmsLink || ""; inp.placeholder = "URL..."; inp.style.width = "90%"; inp.oninput = (e) => { appData.rows[rIdx].wmsLink = e.target.value; markDirty(true); }; inp.onclick = (e) => e.stopPropagation(); tdWms.appendChild(inp); }
            tr.appendChild(tdWms);

            const summaryTd = document.createElement('td'); summaryTd.className = 'col-summary';
            const weekData = (row.weeks && row.weeks[displayWeek-1]) ? row.weeks[displayWeek-1] : {val:'', stat:0};
            summaryTd.innerText = weekData.val;
            
            // DARK MODE STATUS COLOR LOGIC
            if(weekData.stat === 0) {
                summaryTd.style.backgroundColor = ""; // Default CSS dark
                summaryTd.style.color = ""; 
            } else {
                if(appData.statusSettings[weekData.stat]) {
                    summaryTd.style.backgroundColor = appData.statusSettings[weekData.stat].color;
                    summaryTd.style.color = "#000"; // Force black text on colored cells
                }
            }
            tr.appendChild(summaryTd);

            for (let w = 0; w < UGER; w++) {
				const td = document.createElement('td');
				const cellData = row.weeks && row.weeks[w] ? row.weeks[w] : { val: '', stat: 0 };
				td.innerText = cellData.val;
				
				// --- NYT: Skjul uger der ikke er den aktuelle (via CSS class) ---
				// Uge-nummer er w + 1. Hvis det IKKE matcher displayWeek, tilf칮j skjule-klasse
				if ((w + 1) !== displayWeek) {
					td.className = 'mobile-hidden'; 
				}
				// -------------------------------------------------------------

				if(cellData.note) { td.classList.add('has-note'); td.title = cellData.note; }
				
				// Farve logik (behold din eksisterende logik her)
				if (cellData.stat !== 0 && appData.statusSettings[cellData.stat]) {
					td.style.backgroundColor = appData.statusSettings[cellData.stat].color;
					td.style.color = "#000"; 
				}

				// Markering af aktiv uge
				if((w + 1) === displayWeek) { 
					td.style.borderLeft = "2px solid #777"; 
					td.style.borderRight = "2px solid #777"; 
				}
				
				td.tabIndex = 0; 
				
				// --- NYT: Brug handleCellClick i stedet for direkte focus ---
				td.onclick = (e) => handleCellClick(e, rIdx, w);
				// -----------------------------------------------------------

				td.ondblclick = () => handleCellDblClick(rIdx, w); 
				td.onkeydown = (e) => handleInput(e, rIdx, w);
				td.addEventListener('paste', (e) => handleWeekPaste(e, rIdx, w));

				tr.appendChild(td);
			}

            if (!isLocked) {
                appData.settings.forEach(setting => {
                    let count = 0;
                    for(let w=0; w<UGER; w++) { const val = (row.weeks && row.weeks[w]) ? row.weeks[w].val : ""; if(val && val.includes(setting.disp)) count++; }
                    const tdSum = document.createElement('td'); tdSum.className = 'col-sum'; tdSum.innerText = count > 0 ? count : ''; if(count > 0) { tdSum.style.backgroundColor = "#2d2e31"; tdSum.style.color = "#fff"; } 
                    tr.appendChild(tdSum);
                });
            }
            tbody.appendChild(tr);
        });
    }

    // Denne funktion erstatter din gamle createMetaCell
    function createMetaCell(rIdx, key, val, classes) { 
        const td = document.createElement('td'); 
        td.contentEditable = !isLocked; 
        td.className = classes || ''; 
        if(isLocked) td.className += ' locked-cell'; 
        td.innerText = val || ''; 
        
        // Gem data n친r man skriver
        td.oninput = (e) => { 
            // Hvis det er 'nr' kolonnen, fjern alt der ikke er tal mens man skriver
            if(key === 'nr') {
                 const raw = e.target.innerText.replace(/\D/g, '').substring(0, 8);
                 if(e.target.innerText !== raw) {
                     e.target.innerText = raw;
                     // Flyt mark칮r til slutning (n칮dvendigt n친r vi retter teksten mens man skriver)
                     const range = document.createRange();
                     const sel = window.getSelection();
                     range.selectNodeContents(td);
                     range.collapse(false);
                     sel.removeAllRanges();
                     sel.addRange(range);
                 }
            }
            appData.rows[rIdx][key] = e.target.innerText; 
            markDirty(true); 
        }; 

        // NYT: H친ndter Paste (Fjern formatering)
        td.addEventListener('paste', (e) => {
            e.preventDefault(); // Stop standard paste (som tager farver/html med)
            
            // Hent teksten helt rent
            let text = (e.clipboardData || window.clipboardData).getData('text');

            if (key === 'nr') {
                // Kun tal, max 8 cifre
                text = text.replace(/\D/g, '').substring(0, 8);
            } else if (key === 'station') {
                // Ingen linjeskift i station
                text = text.replace(/(\r\n|\n|\r)/gm, " ");
            }

            // Inds칝t den rensede tekst
            document.execCommand('insertText', false, text);
            // Opdater data modellen med det samme
            appData.rows[rIdx][key] = td.innerText;
            markDirty(true);
        });

        return td; 
    }
    function handleCellDblClick(rIdx, wIdx) { const dblStatIndex = appData.statusSettings.findIndex(s => s.shortcut === 'dblclick'); if (dblStatIndex >= 0) { if (!appData.rows[rIdx].weeks) appData.rows[rIdx].weeks = {}; if (!appData.rows[rIdx].weeks[wIdx]) appData.rows[rIdx].weeks[wIdx] = { val: '', stat: 0 }; appData.rows[rIdx].weeks[wIdx].stat = dblStatIndex; markDirty(true); render(); } }
    function handleInput(e, rIdx, wIdx) {
        if (!appData.rows[rIdx].weeks) appData.rows[rIdx].weeks = {}; 
        if (!appData.rows[rIdx].weeks[wIdx]) appData.rows[rIdx].weeks[wIdx] = { val: '', stat: 0 };
        
        let cell = appData.rows[rIdx].weeks[wIdx]; 
        let needsRender = false; 
        const key = e.key.toLowerCase(); 
        
        // Tjek for genveje til status (Tilladt selvom det er l친st)
        const shortcutStatIndex = appData.statusSettings.findIndex(s => s.shortcut && s.shortcut.toLowerCase() === key);
        
        if (shortcutStatIndex >= 0) { 
            e.preventDefault(); 
            cell.stat = shortcutStatIndex; 
            needsRender = true; 
        } 
        else if (key === 'n') { 
            // Noter: Skal man kunne lave noter n친r det er l친st? 
            // Hvis nej, tilf칮j: if (isLocked) return; her
            e.preventDefault(); 
            const currentNote = cell.note || ""; 
            const newNote = prompt("Indtast bem칝rkning:", currentNote); 
            if (newNote !== null) { cell.note = newNote; markDirty(true); render(); return; } 
        }
        else { 
            const setting = appData.settings.find(s => s.key === key); 
            
            // HER ER 칁NDRINGEN: Vi tjekker && !isLocked f칮r vi skriver bogstaver
            if (setting && !isLocked) { 
                cell.val = (cell.val || '') + setting.disp; 
                needsRender = true; 
            } 
            // Backspace m친 ogs친 kun virke hvis ikke l친st
            else if (e.key === 'Backspace' && !isLocked) { 
                e.preventDefault(); 
                if(cell.val.length > 0) { 
                    cell.val = cell.val.slice(0, -1); 
                    needsRender = true; 
                } 
            } 
            // Delete sletter indhold, s친 det b칮r ogs친 v칝re l친st
            else if (e.key === 'Delete' && !isLocked) { 
                cell.val = ''; 
                cell.stat = 0; 
                needsRender = true; 
            } 
            // Space (status skift) er tilladt selvom isLocked er true
            else if (e.key === ' ') { 
                e.preventDefault(); 
                const numStatuses = appData.statusSettings.length; 
                cell.stat = (cell.stat + 1) % numStatuses; 
                needsRender = true; 
            } 
        }
        
        if (needsRender) { 
            markDirty(true); 
            render(); 
            setTimeout(() => { 
                const rows = document.getElementById('tbody').children; 
                if(rows[rIdx]) { 
                    const cell = rows[rIdx].children[wIdx + (isMobile() ? 0 : 7)]; // Justeret index hvis desktop
                    // P친 mobil er strukturen anderledes, men handleInput bruges prim칝rt p친 desktop tastatur
                    // Hvis du bruger den originale desktop visning, er +7 korrekt for at finde cellen
                    if(cell) cell.focus(); 
                } 
            }, 0); 
        }
    }
    function addRow() { appData.rows.push({ station: '', nr: '', togt: '', vandaLink: '', wmsLink: '', weeks: {} }); markDirty(true); render(); }
</script>
<div id="mobileActionMenu" class="overlay-screen" style="display:none; justify-content:flex-end; background: rgba(0,0,0,0.6);">
    <div style="background:#202124; width:100%; border-top-left-radius:16px; border-top-right-radius:16px; padding:20px; border-top:1px solid #5f6368; box-shadow: 0 -4px 10px rgba(0,0,0,0.5);">
        <h3 style="margin-top:0; color:#e8eaed; text-align:center;">V칝lg Status</h3>
        
        <div id="mobileStatusOptions" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px;">
            </div>

        <button onclick="closeMobileMenu()" style="width:100%; margin-top:15px; background:transparent; border:1px solid #5f6368; padding:12px; color:#e8eaed; border-radius: 8px;">Annuller</button>
    </div>
</div>
</body>
</html>
